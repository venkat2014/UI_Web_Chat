<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Agent â€“ Combo1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#4361ee">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="AI Agent">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f0f2f5;
      --sidebar: #202123;
      --user-bg: #4361ee;
      --ai-bg: #f0f2f5;
      --text: #111827;
      --text-secondary: #6b7280;
      --border: #e5e7eb;
      --status: #6b7280;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      height: 100vh;
      background-color: var(--bg);
      color: var(--text);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      /* Safe area for notched devices */
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }

    .app {
      display: flex;
      height: 100%;
      overflow: hidden;
    }

    /* SIDEBAR */
    .sidebar {
      width: 280px;
      background-color: var(--sidebar);
      color: white;
      padding: 16px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: transform 0.3s ease;
      z-index: 10;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #333;
    }

    .new-chat {
      background: #4361ee;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-family: inherit;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .new-chat:hover {
      background: #3a56d4;
    }

    .conversations {
      flex: 1;
      overflow-y: auto;
      padding: 0 4px;
    }

    .conversation {
      padding: 10px 12px;
      border-radius: 6px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .conversation.active {
      background: #333;
      font-weight: 500;
    }

    .conversation:hover {
      background: #333;
    }

    .status {
      padding: 12px 0;
      font-size: 12px;
      color: var(--status);
      border-top: 1px solid #333;
      margin-top: auto;
    }

    /* MAIN CHAT */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: white;
    }

    #chat {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
      /* Prevent pull-to-refresh */
      overscroll-behavior: contain;
    }

    .msg {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 8px;
      line-height: 1.5;
      font-size: 14px;
      word-wrap: break-word;
    }

    .user {
      background-color: var(--user-bg);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 2px;
    }

    .ai {
      background-color: var(--ai-bg);
      color: var(--text);
      align-self: flex-start;
      border-bottom-left-radius: 2px;
    }

    .error {
      background-color: #ff6b6b;
      color: white;
      align-self: flex-start;
      border-bottom-left-radius: 2px;
    }

    #bar {
      padding: 16px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
      background: white;
      /* Stick to bottom on mobile */
      position: sticky;
      bottom: 0;
      /* Safe area for bottom bars */
      padding-bottom: max(16px, env(safe-area-inset-bottom));
    }

    #input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-family: inherit;
      font-size: 14px;
      outline: none;
      transition: border 0.2s;
      min-height: 44px; /* Minimum touch target */
    }

    #input:focus {
      border-color: #4361ee;
    }

    button {
      background: #4361ee;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 16px;
      font-family: inherit;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
      flex-shrink: 0;
      min-height: 44px; /* Minimum touch target */
    }

    button:hover {
      background: #3a56d4;
    }

    /* MIC BUTTON */
    #micBtn {
      background: #ff6b6b;
      width: 44px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #micBtn.recording {
      background: #ff0000;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.6; }
      100% { opacity: 1; }
    }

    /* MOBILE RESPONSIVE */
    @media (max-width: 768px) {
      .app {
        flex-direction: column;
      }

      .sidebar {
        transform: translateX(-100%);
        width: 80%;
        max-width: 320px;
        position: fixed;
        height: 100%;
        top: 0;
        left: 0;
        z-index: 20;
      }

      .sidebar-toggle:checked ~ .sidebar {
        transform: translateX(0);
      }

      .sidebar-toggle-btn {
        position: absolute;
        top: env(safe-area-inset-top, 16px);
        left: 16px;
        z-index: 20;
        background: var(--sidebar);
        color: white;
        border: none;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        cursor: pointer;
        /* Minimum touch target */
        min-width: 44px;
        min-height: 44px;
      }

      .main {
        padding-top: 60px;
      }

      #chat {
        padding: 16px;
      }

      .msg {
        max-width: 90%;
      }

      /* Full-width input on mobile */
      #bar {
        padding: 12px 16px;
        gap: 8px;
      }

      #input {
        padding: 12px 16px;
        font-size: 16px; /* Prevent zoom on iOS */
      }
    }

    /* PWA INSTALL PROMPT */
    #installPrompt {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #4361ee;
      color: white;
      padding: 12px 16px;
      text-align: center;
      display: none;
      z-index: 100;
      font-size: 14px;
    }

    #installPrompt button {
      background: white;
      color: #4361ee;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-weight: 500;
      margin-left: 8px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <input type="checkbox" id="sidebar-toggle" class="sidebar-toggle" hidden>
  <label for="sidebar-toggle" class="sidebar-toggle-btn">â˜°</label>

  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2 style="font-weight: 500; font-size: 18px;">AI Agent</h2>
        <button class="new-chat">+ New Chat</button>
      </div>
      
      <div class="conversations">
        <div class="conversation active">Current Conversation</div>
      </div>
      
      <div id="status" class="status">Status: idle</div>
    </aside>

    <main class="main">
      <div id="chat"></div>
      
      <div id="bar">
        <input
          id="input"
          type="text"
          placeholder="Type or tap mic to speak..."
        />
        <button id="micBtn">ðŸŽ¤</button>
        <button id="sendBtn">Send</button>
      </div>
    </main>
  </div>

  <div id="installPrompt">
    Install AI Agent for offline use!
    <button id="installBtn">Install</button>
  </div>

  <script>
    /* ================= TEMP CONFIG ================= */
   
    const MODEL = "mistralai/mistral-7b-instruct";

    /* ================= STATE ================= */
    let history = [
      { role: "system", content: "You are a helpful AI assistant." }
    ];

    /* ================= DOM ================= */
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const statusEl = document.getElementById("status");
    const sendBtn = document.getElementById("sendBtn");
    const micBtn = document.getElementById("micBtn");
    const installPrompt = document.getElementById("installPrompt");
    const installBtn = document.getElementById("installBtn");

    /* ================= PWA INSTALL PROMPT ================= */
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installPrompt.style.display = 'block';
    });

    if (installBtn) {
      installBtn.addEventListener('click', () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
              console.log('User accepted the install prompt');
            }
            installPrompt.style.display = 'none';
            deferredPrompt = null;
          });
        }
      });
    }

    /* ================= HELPERS ================= */
    function logMsg(text, cls) {
      const d = document.createElement("div");
      d.className = "msg " + cls;
      d.textContent = text;
      chat.appendChild(d);
      chat.scrollTop = chat.scrollHeight;
    }

    function setStatus(t) {
      statusEl.textContent = "Status: " + t;
      console.log("[STATUS]", t);
    }

    /* ================= VOICE RECOGNITION ================= */
    let recognition;
    
    function initVoice() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        micBtn.style.display = 'none';
        return;
      }
      
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = detectLanguage(); // Auto-detect language
      
      recognition.onstart = () => {
        micBtn.classList.add('recording');
        setStatus('Listening...');
      };
      
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        input.value = transcript;
        micBtn.classList.remove('recording');
        setStatus('idle');
        sendMsg(); // Auto-send after speech
      };
      
      recognition.onerror = (event) => {
        micBtn.classList.remove('recording');
        setStatus('Voice error: ' + event.error);
        console.error('Speech recognition error', event.error);
      };
      
      recognition.onend = () => {
        micBtn.classList.remove('recording');
        if (statusEl.textContent.includes('Listening')) {
          setStatus('idle');
        }
      };
    }
    
    function detectLanguage() {
      // Auto-detect based on browser language
      const userLang = navigator.language || navigator.userLanguage;
      if (userLang.startsWith('te')) return 'te-IN'; // Telugu
      if (userLang.startsWith('hi')) return 'hi-IN'; // Hindi
      if (userLang.startsWith('ta')) return 'ta-IN'; // Tamil
      if (userLang.startsWith('kn')) return 'kn-IN'; // Kannada
      return 'en-US'; // Default
    }
    
    // Initialize voice on load
    if (typeof window !== 'undefined') {
      initVoice();
    }

    /* ================= SPEECH SYNTHESIS ================= */
    function speakText(text) {
      if (!('speechSynthesis' in window)) return;
      
      // Cancel any ongoing speech
      window.speechSynthesis.cancel();
      
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = detectLanguage(); // Match input language
      
      // Find best voice for the language
      const voices = speechSynthesis.getVoices();
      const langCode = utterance.lang.split('-')[0];
      
      // Try to find a native voice
      const preferredVoice = voices.find(v => 
        v.lang.startsWith(langCode) && 
        (v.name.includes('Google') || v.name.includes('Microsoft') || v.localService)
      );
      
      if (preferredVoice) {
        utterance.voice = preferredVoice;
      }
      
      utterance.rate = 1.0;
      utterance.pitch = 1.0;
      
      speechSynthesis.speak(utterance);
    }

    /* ================= EVENTS ================= */
    sendBtn.onclick = sendMsg;
    micBtn.onclick = () => {
      if (recognition) {
        recognition.start();
      } else {
        alert('Voice not supported in this browser. Use Chrome/Edge.');
      }
    };

    input.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMsg();
      }
    });

    /* ================= CORE ================= */
    async function sendMsg() {
      const text = input.value.trim();

      if (!text) {
       ("empty input");
        return;
      }

      console.log("[SEND]", text);
      logMsg("You: " + text, "user");

      history.push({ role: "user", content: text });
      input.value = "";

      setStatus("sending requestâ€¦");

      try {
       const res = await fetch("/api/chat", {
  method: "POST",
  headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({
    model: MODEL,
    messages: history,
    max_tokens: 300
  })
});

        setStatus("response received (HTTP " + res.status + ")");

        if (!res.ok) {
          const errorData = await res.json().catch(() => ({}));
          logMsg("HTTP ERROR " + res.status + ": " + JSON.stringify(errorData), "error");
          return;
        }

        const data = await res.json();
        console.log("[RESPONSE]", data);

        if (data.error) {
          logMsg("API ERROR: " + JSON.stringify(data.error), "error");
          return;
        }

        const reply = data?.choices?.[0]?.message?.content;

        if (!reply) {
          logMsg("BAD RESPONSE FORMAT", "error");
          return;
        }

        logMsg("AI: " + reply, "ai");
        history.push({ role: "assistant", content: reply });

        // ðŸ”Š SPEAK THE REPLY
        speakText(reply);

        setStatus("idle");

      } catch (err) {
        console.error("[FETCH ERROR]", err);
        logMsg("JS / NETWORK ERROR: " + err.message, "error");
        setStatus("failed");
      }
    }

    // Load voices (needed for some browsers)
    if ('speechSynthesis' in window) {
      speechSynthesis.onvoiceschanged = () => {};
    }

    /* ================= MOBILE OPTIMIZATIONS ================= */
    // Prevent zoom on input focus (iOS)
    document.addEventListener('DOMContentLoaded', () => {
      const inputs = document.querySelectorAll('input, textarea');
      inputs.forEach(input => {
        input.addEventListener('focus', () => {
          if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
              if (window.visualViewport.height < window.innerHeight) {
                document.body.style.overflow = 'hidden';
              } else {
                document.body.style.overflow = '';
              }
            });
          }
        });
      });
    });
  </script>
</body>
</html>
