<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Agent â€“ Combo1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#4361ee">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="AI Agent">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <!-- BOOTSTRAP 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --vh: 1vh;
      --bg: #f0f2f5;
      --sidebar: #202123;
      --user-bg: #4361ee;
      --ai-bg: #f0f2f5;
      --text: #111827;
      --text-secondary: #6b7280;
      --border: #e5e7eb;
      --status: #6b7280;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      overflow: hidden;
    }

    .chat-container {
      height: calc(100dvh - 140px);
      overflow-y: auto;
      padding: 1rem;
    }

    .msg {
      max-width: 80%;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      margin-bottom: 0.5rem;
      line-height: 1.4;
    }

    .user {
      background-color: var(--user-bg);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }

    .ai {
      background-color: var(--ai-bg);
      color: var(--text);
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }

    .error {
      background-color: #ff6b6b;
      color: white;
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }

    .input-group {
      padding: 0.75rem;
      background: white;
      border-top: 1px solid var(--border);
    }

    .btn-mic {
      background: #ff6b6b;
      border: none;
      min-width: 44px;
      min-height: 44px;
    }

    .btn-mic.recording {
      background: #ff0000;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.6; }
      100% { opacity: 1; }
    }

    .sidebar {
      background: var(--sidebar);
      color: white;
      height: 100dvh;
      overflow-y: auto;
    }

    .conversation.active {
      background: #333;
      font-weight: 500;
    }

    .status {
      padding: 12px 0;
      font-size: 12px;
      color: var(--status);
      border-top: 1px solid #333;
      margin-top: auto;
    }

    /* MOBILE MENU */
    @media (max-width: 991.98px) {
      .sidebar {
        position: fixed;
        left: -100%;
        top: 0;
        width: 80%;
        max-width: 320px;
        z-index: 1000;
        transition: left 0.3s ease;
      }
      
      .sidebar.show {
        left: 0;
      }
      
      .menu-toggle {
        position: fixed;
        top: env(safe-area-inset-top, 10px);
        left: 10px;
        z-index: 1001;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--sidebar);
        color: white;
        font-size: 1.25rem;
      }
    }

    /* PWA INSTALL PROMPT */
    #installPrompt {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #4361ee;
      color: white;
      padding: 12px 16px;
      text-align: center;
      display: none;
      z-index: 100;
      font-size: 14px;
    }

    #installPrompt button {
      background: white;
      color: #4361ee;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-weight: 500;
      margin-left: 8px;
      cursor: pointer;
    }
  </style>
</head>

<body class="d-flex">
  <!-- Mobile Menu Toggle -->
  <button class="menu-toggle d-lg-none" id="menuToggle">â˜°</button>

  <!-- Sidebar (Hidden on mobile by default) -->
  <div class="sidebar col-lg-3 p-3 d-none d-lg-block" id="sidebar">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">AI Agent</h5>
      <button class="btn btn-primary btn-sm new-chat">+ New Chat</button>
    </div>
    
    <div class="conversations">
      <div class="conversation active py-2 px-2 rounded mb-2">Current Conversation</div>
    </div>
    
    <div class="status">Status: idle</div>
  </div>

  <!-- Main Chat Area -->
  <div class="flex-grow-1 d-flex flex-column">
    <div class="chat-container" id="chat"></div>
    
    <div class="input-group">
      <input type="text" class="form-control" id="input" placeholder="Type or tap mic to speak...">
      <button class="btn btn-mic" id="micBtn">ðŸŽ¤</button>
      <button class="btn btn-primary" id="sendBtn">Send</button>
    </div>
  </div>

  <div id="installPrompt">
    Install AI Agent for offline use!
    <button id="installBtn">Install</button>
  </div>

  <!-- BOOTSTRAP JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    /* ================= TEMP CONFIG ================= */
    const MODEL = "mistralai/mistral-7b-instruct";
   let history = [{ 
  role: "system", 
  content: "Always reply in the same language as the user. If the user writes in Telugu, reply in Telugu. If in Hindi, reply in Hindi. Keep replies short and clear." 
}];

    /* ================= DOM ================= */
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const statusEl = document.querySelector(".status");
    const sendBtn = document.getElementById("sendBtn");
    const micBtn = document.getElementById("micBtn");
    const menuToggle = document.getElementById("menuToggle");
    const sidebar = document.getElementById("sidebar");
    const installPrompt = document.getElementById("installPrompt");
    const installBtn = document.getElementById("installBtn");

    /* ================= MOBILE MENU ================= */
    if (menuToggle) {
      menuToggle.addEventListener("click", () => {
        sidebar.classList.toggle("show");
      });
    }

    /* ================= PWA INSTALL PROMPT ================= */
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installPrompt.style.display = 'block';
    });

    if (installBtn) {
      installBtn.addEventListener('click', () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
              console.log('User accepted the install prompt');
            }
            installPrompt.style.display = 'none';
            deferredPrompt = null;
          });
        }
      });
    }

    /* ================= HELPERS ================= */
    function logMsg(text, cls) {
      const div = document.createElement("div");
      div.className = `msg ${cls}`;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function setStatus(t) {
      if (statusEl) statusEl.textContent = `Status: ${t}`;
    }

    /* ================= VOICE RECOGNITION ================= */
    let recognition;
    function initVoice() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        micBtn.style.display = 'none';
        return;
      }
      
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = detectLanguage();
      
      recognition.onstart = () => {
        micBtn.classList.add('recording');
        setStatus('Listening...');
      };
      
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        input.value = transcript;
        micBtn.classList.remove('recording');
        setStatus('idle');
        sendMsg();
      };
      
      recognition.onerror = (event) => {
        micBtn.classList.remove('recording');
        setStatus('Voice error: ' + event.error);
        console.error('Speech recognition error', event.error);
      };
      
      recognition.onend = () => {
        micBtn.classList.remove('recording');
        if (statusEl && statusEl.textContent.includes('Listening')) {
          setStatus('idle');
        }
      };
    }

    function detectLanguage() {
      const userLang = navigator.language || navigator.userLanguage;
      if (userLang.startsWith('te')) return 'te-IN';
      if (userLang.startsWith('hi')) return 'hi-IN';
      if (userLang.startsWith('ta')) return 'ta-IN';
      if (userLang.startsWith('kn')) return 'kn-IN';
      return 'en-US';
    }

    /* ================= SPEECH SYNTHESIS (GOOGLE TTS) ================= */
    async function speakText(text) {
      // Auto-detect language from text
      let lang = 'en';
      if (/[\u0900-\u097F]/.test(text)) lang = 'hi'; // Hindi
      if (/[\u0C00-\u0C7F]/.test(text)) lang = 'te'; // Telugu
      if (/[\u0B80-\u0BFF]/.test(text)) lang = 'ta'; // Tamil
      if (/[\u0C80-\u0CFF]/.test(text)) lang = 'kn'; // Kannada
      if (/[\u0D00-\u0D7F]/.test(text)) lang = 'ml'; // Malayalam

      try {
        const response = await fetch('/api/tts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, lang })
        });

        if (!response.ok) return;

        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        const audio = new Audio(audioUrl);
        audio.onended = () => URL.revokeObjectURL(audioUrl);
        audio.play();
      } catch (err) {
        console.error("Google TTS failed:", err);
        // Optional: fallback to browser voice
        // fallbackToBrowserVoice(text, lang);
      }
    }

    /* ================= CORE ================= */
    async function sendMsg() {
      const text = input.value.trim();
      if (!text) return;

      logMsg("You: " + text, "user");
      history.push({ role: "user", content: text });
      input.value = "";
      setStatus("sending requestâ€¦");

      try {
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: MODEL,
            messages: history,
            max_tokens: 300
          })
        });

        setStatus("response received (HTTP " + res.status + ")");

        if (!res.ok) {
          const errorData = await res.json().catch(() => ({}));
          logMsg("HTTP ERROR " + res.status + ": " + JSON.stringify(errorData), "error");
          return;
        }

        const data = await res.json();
        if (data.error) {
          logMsg("API ERROR: " + JSON.stringify(data.error), "error");
          return;
        }

        const reply = data?.choices?.[0]?.message?.content;
        if (!reply) {
          logMsg("BAD RESPONSE FORMAT", "error");
          return;
        }

        logMsg("AI: " + reply, "ai");
        history.push({ role: "assistant", content: reply });
        speakText(reply);
        setStatus("idle");
      } catch (err) {
        console.error("[FETCH ERROR]", err);
        logMsg("JS / NETWORK ERROR: " + err.message, "error");
        setStatus("failed");
      }
    }

    /* ================= EVENTS ================= */
    sendBtn.addEventListener("click", sendMsg);
    micBtn.addEventListener("click", () => {
      if (recognition) recognition.start();
    });
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMsg();
      }
    });

    /* ================= INIT ================= */
    initVoice();
  </script>
</body>
</html>
